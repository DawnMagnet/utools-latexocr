(()=>{"use strict";var t={d:(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};t.d({},{cp:()=>k});const e=document.getElementById("lineWidth");const o={mouseMove:function(t){const{startX:e,startY:o}=this.startPosition;this.clearFrontContext(),this.frontContext.beginPath(),this.frontContext.moveTo(e,o),this.frontContext.lineTo(t.offsetX,o),this.frontContext.lineTo(t.offsetX,t.offsetY),this.frontContext.lineTo(e,t.offsetY),this.frontContext.closePath(),this.frontContext.stroke()},mouseUp:function(t){this.clearFrontContext();const{startY:e,startX:o}=this.startPosition;this.drawContext.strokeRect(o,e,t.offsetX-o,t.offsetY-e)},init:function(t,o){this.setCursorSize(e.value,!1),document.body.onmousewheel=function(t){const o=parseInt(e.value)+(t.deltaY<0?2:-2);e.value=o<=0?2:o,this.setCursorSize(e.value,!1)}.bind(this),window.Mousetrap.bind("=",(()=>{e.value=parseInt(e.value)+2,this.setCursorSize(e.value,!1)})),window.Mousetrap.bind("-",(()=>{e.value=parseInt(e.value)-2,e.value<1&&(e.value=1),this.setCursorSize(e.value,!1)}))},config:{group:1,position:1,icon:"&#xe61c;",name:"rectangle",settingBox:"color&size",useKeyword:"2",canvas:!0,history:!0,cursor:!0,hint:"画矩形"},destroy:function(){document.body.onmousewheel=null,window.Mousetrap.unbind("="),window.Mousetrap.unbind("-")}},n=document.getElementById("lineWidth");const i={mouseMove:function(t){const{startX:e,startY:o}=this.startPosition;this.clearFrontContext(),this.frontContext.beginPath();const n=t.offsetX-e,i=t.offsetY-o;this.frontContext.ellipse(e+n/2,o+i/2,Math.abs(n/2),Math.abs(i/2),0,0,2*Math.PI),this.frontContext.stroke()},mouseUp:function(t){this.clearFrontContext();const{startX:e,startY:o}=this.startPosition,n=t.offsetX-e,i=t.offsetY-o;this.drawContext.beginPath(),this.drawContext.ellipse(e+n/2,o+i/2,Math.abs(n/2),Math.abs(i/2),0,0,2*Math.PI),this.drawContext.stroke()},config:{group:1,position:2,icon:"&#xe61d;",name:"circle",settingBox:"color&size",useKeyword:"3",canvas:!0,history:!0,cursor:!0,hint:"画圆形"},init:function(t,e){this.setCursorSize(n.value,!1),document.body.onmousewheel=function(t){const e=parseInt(n.value)+(t.deltaY<0?2:-2);n.value=e<=0?2:e,this.setCursorSize(n.value,!1)}.bind(this),window.Mousetrap.bind("=",(()=>{n.value=parseInt(n.value)+2,this.setCursorSize(n.value,!1)})),window.Mousetrap.bind("-",(()=>{n.value=parseInt(n.value)-2,n.value<1&&(n.value=1),this.setCursorSize(n.value,!1)}))},destroy:function(){document.body.onmousewheel=null,window.Mousetrap.unbind("="),window.Mousetrap.unbind("-")}},s=document.getElementById("lineWidth");const r={mouseUp:function(t){},mouseDown:function(t){const{startX:e,startY:o}=this.startPosition;this.drawContext.moveTo(e,o),this.setCanvasStyle(this.drawContext),this.drawContext.beginPath()},mouseMove:function(t){this.drawContext.lineTo(t.offsetX,t.offsetY),this.drawContext.stroke()},config:{group:1,position:5,icon:"&#xe620;",name:"brush",settingBox:"color&size",useKeyword:"6",canvas:!1,history:!0,cursor:!0,hint:"画笔"},init:function(t,e){this.setCursorSize(s.value,!1),document.body.onmousewheel=function(t){const e=parseInt(s.value)+(t.deltaY<0?2:-2);s.value=e<=0?2:e,this.setCursorSize(s.value,!1)}.bind(this),window.Mousetrap.bind("=",(()=>{s.value=parseInt(s.value)+2,this.setCursorSize(s.value,!1)})),window.Mousetrap.bind("-",(()=>{s.value=parseInt(s.value)-2,s.value<1&&(s.value=1),this.setCursorSize(s.value,!1)}))},destroy:function(){document.body.onmousewheel=null,window.Mousetrap.unbind("="),window.Mousetrap.unbind("-")}},a=document.getElementById("lineWidth");function u(t,e,o,n){const i=Math.PI/12,s=Math.atan2(n-e,o-t);return[o-20*Math.sin(Math.PI/2-s-i),n-20*Math.cos(Math.PI/2-s-i),o-12*Math.cos(s),n-12*Math.sin(s),o-20*Math.cos(s-i),n-20*Math.sin(s-i)]}const c={mouseMove:function(t){const{startX:e,startY:o}=this.startPosition,n=t.offsetX,i=t.offsetY,[s,r,a,c,l,h]=u(e,o,n,i);this.clearFrontContext(),this.frontContext.beginPath(),this.frontContext.moveTo(e,o),this.frontContext.lineTo(n,i),this.frontContext.moveTo(a,c),this.frontContext.lineTo(s,r),this.frontContext.lineTo(n,i),this.frontContext.lineTo(l,h),this.frontContext.lineTo(a,c),this.frontContext.stroke()},mouseUp:function(t){this.clearFrontContext();const{startX:e,startY:o}=this.startPosition,n=t.offsetX,i=t.offsetY,[s,r,a,c,l,h]=u(e,o,n,i);this.drawContext.beginPath(),this.drawContext.moveTo(e,o),this.drawContext.lineTo(n,i),this.drawContext.moveTo(a,c),this.drawContext.lineTo(s,r),this.drawContext.lineTo(n,i),this.drawContext.lineTo(l,h),this.drawContext.lineTo(a,c),this.drawContext.stroke()},config:{group:1,position:3,icon:"&#xe69a;",name:"arrow",settingBox:"color&size",useKeyword:"4",canvas:!0,history:!0,cursor:!0,hint:"箭头"},init:function(t,e){this.setCursorSize(a.value,!1),document.body.onmousewheel=function(t){const e=parseInt(a.value)+(t.deltaY<0?2:-2);a.value=e<=0?2:e,this.setCursorSize(a.value,!1)}.bind(this),window.Mousetrap.bind("=",(()=>{a.value=parseInt(a.value)+2,this.setCursorSize(a.value,!1)})),window.Mousetrap.bind("-",(()=>{a.value=parseInt(a.value)-2,a.value<1&&(a.value=1),this.setCursorSize(a.value,!1)}))},destroy:function(){document.body.onmousewheel=null,window.Mousetrap.unbind("="),window.Mousetrap.unbind("-")}},l=document.getElementById("container_move");const h={init:function(t,e){l.style.display="block"},destroy:function(){l.style.display="none"},config:{group:0,position:1,icon:"&#xe616;",name:"move",useKeyword:"1",hint:"拖拽"}};let d=!1,f=[];const p=void 0!==window.ontouchstart,m=function(t,e,{onStart:o,onEnd:n,onMove:i,onCheck:s,preventDefault:r=!0}={}){d||document.addEventListener(p?"touchmove":"mousemove",(function(t){let e=t;if(t.touches&&(e=t.touches[0]),s&&!1===s(t.target,t))return!1;for(var o=0;o<f.length;o++)f[o](e.clientX,e.clientY)})),d=!0;let a=!1,u=!1,c=0,l=0,h=0,m=0;e.addEventListener(p?"touchstart":"mousedown",(function(e){if(e.stopPropagation(),r&&e.preventDefault(),"false"===t.dataset.dragEnabled)return;let o=e;e.touches&&(o=e.touches[0]),a=!0,c=t.offsetLeft-o.clientX,l=t.offsetTop-o.clientY})),document.addEventListener(p?"touchend":"mouseup",(function(e){n&&u&&n(t,parseInt(t.style.left),parseInt(t.style.top)),a=!1,u=!1})),f.push((function(e,n){if(a){if(u||(u=!0,o&&o(t,h,m)),h=e+c,m=n+l,"true"===t.dataset.dragBoundary&&(h=Math.min(window.innerWidth-t.offsetWidth,Math.max(0,h)),m=Math.min(window.innerHeight-t.offsetHeight,Math.max(0,m))),i){if(!1===i(t,h,m))return h=parseInt(t.style.left),void(m=parseInt(t.style.top))}t.style.left=h+"px",t.style.top=m+"px"}}))},w=document.getElementById("fontSize"),v=document.getElementById("fontColor");const x={init:function(t,e){document.querySelectorAll(".text_input").forEach((t=>{t.className="text_input",t.contentEditable=!0,console.log(t)}))},mouseDown:function(t){let{startX:e,startY:o}=this.startPosition;const n=document.createElement("div");n.contentEditable=!0,n.classList.add("text_input"),e+23>this.containerWidth&&(e-=25),o+45>this.containerHeight&&(o-=42),n.style.maxHeight=this.containerHeight-o-12+"px",n.style.left=e+"px",n.style.top=o+"px",n.style.fontFamily="Microsoft YaHei,Sans Serif,System UI",n.style.fontSize=`${w.value}px`,n.style.color=v.value,this.$mainContainer.append(n),setTimeout((()=>{n.focus()}),250),n.onfocus=t=>{n.classList.add("text_input_active")},n.onblur=t=>{t.target.innerText?t.target.classList.remove("text_input_active","text_input_move"):t.target.remove()},n.onclick=t=>{if(n.classList.contains("text_input_active"))return;const e=t.target;e.contentEditable=!0,e.classList.add("text_input_active"),e.focus()},m(n,n,{onStart:t=>{t.classList.add("text_input_move")},onCheck:(t,e)=>(e.ctrlKey||e.preventDefault(),!e.ctrlKey),onMove:(t,e,o)=>e>0&&o>0&&e+t.clientWidth<this.containerWidth&&o+t.clientHeight<this.containerHeight,onEnd:t=>{t.style.maxHeight=this.containerHeight-parseInt(t.style.top)-12+"px",t.classList.remove("text_input_move")},preventDefault:!1})},destroy:function(){document.querySelectorAll(".text_input").forEach((t=>{t.className="text_input stopEvents",t.contentEditable=!1}))},config:{group:1,position:7,icon:"&#xe652;",name:"textBox",useKeyword:"ctrl+t",settingBox:"textBox",canvas:!1,hint:"文本工具"}};let g=50;const y={init:function(){this.setCursorSize(g,!1),document.body.onmousewheel=function(t){const e=g+(t.deltaY<0?2:-2);g=e<=0?2:e,this.setCursorSize(g,!1)}.bind(this),window.Mousetrap.bind("=",(()=>{g++,this.setCursorSize(g,!1)})),window.Mousetrap.bind("-",(()=>{g--,this.setCursorSize(g,!1)}))},destroy:function(){document.body.onmousewheel=null,window.Mousetrap.unbind("="),window.Mousetrap.unbind("-")},config:{group:1,position:9,icon:"&#xe67b;",name:"erasure",useKeyword:"8",history:!0,cursor:!0,hint:"橡皮擦"},mouseMove:function(t){let e=t.clientX,o=t.clientY;const n=g/2;for(let t=0;t<=n;t++){const i=n-t,s=Math.sqrt(n*n-i*i),r=e-i,a=o-s,u=2*i,c=2*s;this.drawContext.clearRect(r,a,u,c)}}};const C={config:{group:3,position:1,icon:"&#xe625;",name:"saveImage",hint:"保存"},init:function(t,e){this.saveImageToFile().then((()=>{console.log(t),this.setCurrentTool(t)}))}};const b={init:function(t,e){this.canvasToBase64().then((t=>{window.ipcRendererUtils.sendMainMessage("goto:suspension",{base64:t}),window.ipcRendererUtils.winClose()}))},config:{group:2,position:1,icon:"&#xe7f1;",useKeyword:"q",name:"suspension",hint:"去悬浮插件"}};const M={init:function(t,e){const{port:o=4126,bed:n="",uploadLaterClose:i=!1}=window.UToolsUtils.read("uploadImage/setting")||{};console.log(n),this.canvasToBase64().then((async e=>{try{await fetch(`http://localhost:${o}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n?`base64=${e}&autoCopy=true&bed=${n}`:`base64=${e}&autoCopy=true`}).then((t=>t.text()))&&(this.showTips("上传成功"),i&&window.ipcRendererUtils.winClose())}catch(t){this.showTips("上传失败")}finally{this.setCurrentTool(t)}}))},config:{group:2,position:2,icon:"&#xe62b;",name:"uploadImage",useKeyword:"ctrl+f",hint:"上传图床"}};const I={init:function(t,e){window.ipcRendererUtils.winClose()},config:{group:3,position:2,icon:"&#xeca0;",name:"close",hint:"关闭",useKeyword:"esc"}};let S=12;const T={mouseMove:function(t){const{startX:e,startY:o}=this.startPosition,n=this.mainContext.getImageData(t.offsetX,t.offsetY,S,S).data;let i=0,s=0,r=0;for(let t=0;t<S;t++)for(let e=0;e<S;e++)i+=n[4*(S*t+e)],s+=n[4*(S*t+e)+1],r+=n[4*(S*t+e)+2];i=Math.round(i/(S*S)),s=Math.round(s/(S*S)),r=Math.round(r/(S*S));const a=`rgba(${i}, ${s}, ${r}, 0.8)`;this.drawContext.save(),this.drawContext.fillStyle=a,this.drawContext.fillRect(t.offsetX,t.offsetY-S/2,S,S)},config:{group:1,position:10,icon:"&#xe611;",name:"mosaic",history:!0,useKeyword:"9",cursor:!0,hint:"马赛克"},init:function(){this.setCursorSize(S,!1),document.body.onmousewheel=t=>{const e=S+(t.deltaY<0?2:-2);S=e<=0?2:e,this.setCursorSize(S,!1)},window.Mousetrap.bind("=",(()=>{S++,this.setCursorSize(S,!1)})),window.Mousetrap.bind("-",(()=>{S--,this.setCursorSize(S,!1)}))},destroy:function(){document.body.onmousewheel=null,window.Mousetrap.unbind("="),window.Mousetrap.unbind("-")}};const z={init:function(t,e){this.canvasToBase64().then((t=>{const{ocrName:e="OCR 识别"}=window.UToolsUtils.read("ocr/setting")||{};utools.showMainWindow(),utools.redirect(e,{type:"img",data:t}),setTimeout((()=>{window.ipcRendererUtils.winClose()}),100)}))},config:{group:2,position:3,icon:"&#xe605;",name:"ocr",useKeyword:"ctrl+q",hint:"识别"}};const Y={init:function(t,e){if(!this.history.length)return this.showTips("没有更多历史记录了"),void this.setCurrentTool(t);const{type:o,data:n}=this.history.pop();if("draw"===o)this.drawContext.putImageData(n,0,0);else{const t=k(o,"rollBack");t&&t.bind(this)(n)}this.setCurrentTool(t)},config:{group:1,position:11,icon:"&#xea12;",name:"backout",useKeyword:"ctrl+z",hint:"撤回"}};const E={init:function(t,e){this.canvasToBase64().then((t=>{utools.copyImage(t),window.ipcRendererUtils.winClose()}))},config:{group:3,position:3,icon:"&#xeaf1;",name:"saveClose",useKeyword:["ctrl+shift+c","enter"],hint:"复制并关闭"}},P=document.getElementById("lineWidth");const B={mouseUp:function(t){this.clearFrontContext(),this.setCanvasStyle(this.drawContext);const{startX:e,startY:o}=this.startPosition,n=t.offsetX,i=t.offsetY;this.drawContext.beginPath(),this.drawContext.moveTo(e,o),this.drawContext.lineTo(n,i),this.drawContext.lineTo(n,i),this.drawContext.stroke()},mouseDown:function(t){const{startX:e,startY:o}=this.startPosition;this.setCanvasStyle(this.frontContext)},mouseMove:function(t){const{startX:e,startY:o}=this.startPosition,n=t.offsetX,i=t.offsetY;this.clearFrontContext(),this.frontContext.beginPath(),this.frontContext.moveTo(e,o),this.frontContext.lineTo(n,i),this.frontContext.lineTo(n,i),this.frontContext.stroke()},config:{group:1,position:4,icon:"&#xe66d;",name:"straightLine",settingBox:"color&size",useKeyword:"5",canvas:!1,history:!0,cursor:!0,hint:"画直线"},init:function(t,e){this.setCursorSize(P.value,!1),document.body.onmousewheel=function(t){const e=parseInt(P.value)+(t.deltaY<0?2:-2);P.value=e<=0?2:e,this.setCursorSize(P.value,!1)}.bind(this),window.Mousetrap.bind("=",(()=>{P.value=parseInt(P.value)+2,this.setCursorSize(P.value,!1)})),window.Mousetrap.bind("-",(()=>{P.value=parseInt(P.value)-2,P.value<1&&(P.value=1),this.setCursorSize(P.value,!1)}))},destroy:function(){document.body.onmousewheel=null,window.Mousetrap.unbind("="),window.Mousetrap.unbind("-")}},X=document.getElementById("fontSize"),W=document.getElementById("fontColor"),_=document.getElementById("serial_number_box");const H={rectangle:o,saveClose:E,circle:i,brush:r,move:h,textBox:x,arrow:c,erasure:y,saveImage:C,suspension:b,uploadImage:M,ocr:z,close:I,mosaic:T,backout:Y,straightLine:B,serialNumberBox:{init:function(t,e){for(let t=0;t<_.children.length;t++){const e=_.children.item(t);e.contentEditable=!0,e.style.pointerEvents="auto"}},mouseDown:function(t){let{startX:e,startY:o}=this.startPosition;const n=document.createElement("div"),i=document.createElement("div"),s=document.createElement("span");n.append(i),n.append(s),i.contentEditable=!0,console.log(_.children),s.innerText=`${_.children.length+1}`,console.log(e,this.containerWidth),e+80>this.containerWidth?(n.classList.add("right"),n.style.right=this.containerWidth-e+20+"px",n.dataset.right="true"):n.style.left=`${e+20}px`,o+45>this.containerHeight&&(o-=42),i.style.maxHeight=this.containerHeight-o-16+"px",n.style.top=o-15+"px",n.style.fontFamily="Microsoft YaHei,Sans Serif,System UI",n.style.fontSize=`${X.value}px`,s.style.background=W.value,_.append(n),m(n,s,{onStart:t=>{if(t.classList.contains("right")){const e=parseInt(t.style.right);t.style.right="",t.style.left=this.containerWidth-e-t.clientWidth+"px"}},onMove:(t,e,o)=>t.classList.contains("right")?e>0&&o>0&&e+30<this.containerWidth-t.offsetWidth&&o<this.containerHeight-t.offsetHeight:e>30&&o>0&&e<this.containerWidth-t.offsetWidth&&o<this.containerHeight-t.offsetHeight,onEnd:t=>{if(i.style.maxHeight=this.containerHeight-parseInt(t.style.top)-16+"px",t.dataset.right){const e=parseInt(t.style.left);t.style.left="",t.style.right=this.containerWidth-e-t.clientWidth+"px"}}}),i.onblur=t=>{t.target.innerText||(n.remove(),function(){for(let t=0;t<_.children.length;t++)_.children.item(t).querySelector("span").innerText=`${t+1}`}())},setTimeout((()=>{i.focus()}),200),this.isDown=!1},destroy:function(){for(let t=0;t<_.children.length;t++){const e=_.children.item(t);e.contentEditable=!1,e.style.pointerEvents="none"}},config:{group:1,position:8,icon:"&#xe63e;",name:"serialNumberBox",useKeyword:"ctrl+y",settingBox:"textBox",canvas:!1,hint:"序号工具"}}},k=(t,e)=>(console.log(t),H[t]?H[t][e]:void 0);function K(){this.value=this.value.replace(/\D/g,"")}document.querySelectorAll('input[name="number"]').forEach((t=>{t.onkeyup=K}))})();